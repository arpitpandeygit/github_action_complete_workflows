name: Deploy to ECS

on:
  workflow_run:
    workflows: ["Build & Push Image"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ✅ Wait if previous deployment running
      - name: Wait for active deployment
        run: |
          while aws deploy list-deployments \
            --application-name dev-codedeploy \
            --deployment-group-name dev-dg \
            --include-only-statuses InProgress \
            --query "deployments" \
            --output text | grep -q .; do
              echo "Waiting for active deployment..."
              sleep 15
          done

      # ✅ Get latest task definition
      - name: Get task definition ARN
        id: taskdef
        run: |
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition dev-strapi \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)
          echo "task_def=$TASK_DEF" >> $GITHUB_OUTPUT

      # ✅ Create revision for CodeDeploy
      - name: Create revision
        run: |
          cat > revision.json <<EOF
          {
            "applicationName": "dev-codedeploy",
            "deploymentGroupName": "dev-dg",
            "revision": {
              "revisionType": "AppSpecContent",
              "appSpecContent": {
                "content": "{\"version\":1,\"Resources\":[{\"TargetService\":{\"Type\":\"AWS::ECS::Service\",\"Properties\":{\"TaskDefinition\":\"${{ steps.taskdef.outputs.task_def }}\",\"LoadBalancerInfo\":{\"ContainerName\":\"strapi\",\"ContainerPort\":1337}}}}]}"
              }
            }
          }
          EOF

      # ✅ Trigger blue/green deployment
      - name: Deploy
        run: aws deploy create-deployment --cli-input-json file://revision.json